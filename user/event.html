<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Events - DMYSC</title>
    <link rel="icon" type="image/png" href="../assets/logo_1.png">
    
    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- MATERIAL SYMBOLS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    colors: { 
                        background: '#121212',
                        surface: '#1E1E1E',
                        'surface-container': '#252529',
                        primary: '#a6f7bd',
                        'on-primary': '#003915',
                        secondary: '#c2c9bd',
                        tertiary: '#a0cfd0',
                        error: '#ffb4ab',
                        'on-error': '#690005'
                    }, 
                    fontFamily: { 
                        sans: ['Roboto', 'sans-serif'],
                        display: ['Outfit', 'sans-serif']
                    }, 
                    borderRadius: {
                        '4xl': '28px',
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.2, 0.0, 0, 1.0)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                } 
            } 
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        body { 
            background-color: #121212;
            color: #E3E3E3;
            -webkit-tap-highlight-color: transparent;
        }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        
        .m3-card {
            background-color: #1E1E1E;
            border-radius: 24px;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .m3-card:hover {
            background-color: #28282D;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .m3-navbar { background-color: #252529; border-radius: 999px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Calendar Styles */
        .cal-day { 
            width: 36px; height: 36px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-radius: 50%; font-size: 12px; margin: auto; 
            color: #C4C7C5; font-weight: 500; position: relative;
            transition: all 0.2s; cursor: pointer;
        }
        .cal-day:hover { background-color: #353539; color: #E3E3E3; }
        
        /* Today */
        .cal-day.today { background-color: #a6f7bd; color: #003915; font-weight: 700; }
        
        /* Holiday */
        .cal-day.holiday { color: #ffb4ab; font-weight: 700; }
        .cal-day.holiday::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #ffb4ab; border-radius: 50%; }
        .cal-day.today.holiday { color: #003915; }
        .cal-day.today.holiday::after { background: #003915; }

        /* Event Day */
        .cal-day.has-event { border: 1px solid #a6f7bd; color: #a6f7bd; }
        .cal-day.has-event.today { border: none; background-color: #a6f7bd; color: #003915; }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-0 font-sans">

    <!-- Top Navigation (Desktop) -->
    <nav class="sticky top-4 z-40 w-full px-4 no-print">
        <div class="max-w-7xl mx-auto m3-navbar px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3 pl-2 group">
                <button class="w-8 h-8 rounded-full bg-[#353539] flex items-center justify-center group-hover:bg-primary group-hover:text-[#003915] transition">
                    <span class="material-symbols-rounded text-[20px]">arrow_back</span>
                </button>
                <div class="flex flex-col">
                    <span class="text-sm font-display font-medium text-[#E3E3E3]">Events</span>
                    <span class="text-[10px] text-secondary tracking-wider font-bold">Schedule</span>
                </div>
            </a>
            
            <div class="flex items-center gap-3">
                <a href="notifycation.html" class="relative w-10 h-10 flex items-center justify-center rounded-full hover:bg-[#3b3b3f] transition text-[#C4C7C5]">
                    <span class="material-symbols-rounded">notifications</span>
                </a>
                <a href="profile.html" class="w-10 h-10 rounded-full p-1 hover:bg-[#3b3b3f] transition hidden md:block">
                    <img id="navAvatar" src="https://img.freepik.com/premium-vector/green-user-account-profile-flat-icon-apps-websites_1254296-1186.jpg" class="w-full h-full rounded-full object-cover">
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- Header Card -->
        <div class="m3-card p-6 md:p-8 relative overflow-hidden bg-[#252529] mb-6" data-aos="fade-down">
            <div class="relative z-10">
                <div class="flex items-center gap-2 text-primary mb-2">
                    <span class="material-symbols-rounded">calendar_month</span>
                    <span class="text-xs font-bold uppercase tracking-widest">Upcoming</span>
                </div>
                <h1 class="text-3xl md:text-5xl font-display font-normal text-[#E3E3E3] leading-tight">
                    Club <span class="text-primary">Activities</span>
                </h1>
                <p class="text-[#C4C7C5] mt-2 text-sm md:text-base max-w-xl">
                    Join us in our upcoming programs and community events.
                </p>
            </div>
            <!-- Decorative Elements -->
            <div class="absolute top-[-20px] right-[-20px] w-64 h-64 bg-primary opacity-5 rounded-full blur-3xl"></div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            
            <!-- Left Column: Event Feed -->
            <div class="flex-1 space-y-4" id="eventFeed">
                <!-- Loading State -->
                <div class="py-20 text-center">
                    <span class="material-symbols-rounded animate-spin text-4xl text-primary mb-2">sync</span>
                    <p class="text-xs text-[#C4C7C5] uppercase tracking-widest">Loading Events...</p>
                </div>
            </div>

            <!-- Right Column: Calendar Widget -->
            <div class="w-full lg:w-80 shrink-0 space-y-4 lg:order-last">
                
                <!-- Calendar -->
                <div class="m3-card p-5 bg-[#252529]" data-aos="fade-left">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-[#353539]">
                        <h2 class="font-display font-medium text-[#E3E3E3] text-sm" id="calDisplayMonth">January 2026</h2>
                        <div class="flex gap-1">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full hover:bg-[#353539] text-[#C4C7C5] flex items-center justify-center transition"><span class="material-symbols-rounded text-[20px]">chevron_left</span></button>
                            <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full hover:bg-[#353539] text-[#C4C7C5] flex items-center justify-center transition"><span class="material-symbols-rounded text-[20px]">chevron_right</span></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 text-center mb-2 text-[10px] font-bold text-[#8e918f] uppercase tracking-widest">
                        <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                    </div>
                    <div class="grid grid-cols-7 gap-y-1" id="calGrid"></div>
                    
                    <div class="mt-4 pt-4 border-t border-[#353539] flex flex-wrap gap-3 justify-center text-[9px] font-bold text-[#8e918f] uppercase tracking-wider">
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-primary"></span> Today</div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-error"></span> Holiday</div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full border border-primary"></span> Event</div>
                    </div>
                </div>

                <!-- Special Days -->
                <div class="m3-card p-5 bg-[#1E1E1E]" data-aos="fade-left" data-aos-delay="100">
                    <h3 class="text-xs font-bold text-primary uppercase mb-3 tracking-widest flex items-center gap-2">
                        <span class="material-symbols-rounded text-[16px]">star</span> Major Holidays
                    </h3>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-[#252529] transition group cursor-default">
                            <div class="bg-[#353539] text-[#E3E3E3] font-bold text-xs p-2 rounded-lg min-w-[36px] text-center">01</div>
                            <span class="text-xs font-medium text-[#C4C7C5] uppercase">Jan - New Year</span>
                        </div>
                        <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-[#252529] transition group cursor-default">
                            <div class="bg-[#3c2525] text-error font-bold text-xs p-2 rounded-lg min-w-[36px] text-center">04</div>
                            <span class="text-xs font-medium text-error uppercase">Feb - Independence</span>
                        </div>
                        <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-[#252529] transition group cursor-default">
                            <div class="bg-[#1d2a3b] text-tertiary font-bold text-xs p-2 rounded-lg min-w-[36px] text-center">14</div>
                            <span class="text-xs font-medium text-tertiary uppercase">Apr - New Year</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Footer -->
    <div id="global-footer-placeholder" class="pb-20 md:pb-0"></div>

    <!-- Mobile Bottom Nav -->
    <div class="md:hidden fixed bottom-0 left-0 w-full z-50 bg-[#1E1E1E] border-t border-[#252529] pb-safe">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center gap-1 w-full text-[#C4C7C5]">
                <span class="material-symbols-rounded">home</span>
                <span class="text-[10px] font-medium">Home</span>
            </a>
            <button class="flex flex-col items-center gap-1 w-full text-primary">
                <div class="w-12 h-7 rounded-full bg-[#003915] flex items-center justify-center">
                    <span class="material-symbols-rounded text-[20px]">event</span>
                </div>
                <span class="text-[10px] font-medium">Events</span>
            </button>
            <a href="profile.html" class="flex flex-col items-center gap-1 w-full text-[#C4C7C5]">
                <span class="material-symbols-rounded">person</span>
                <span class="text-[10px] font-medium">Profile</span>
            </a>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="../js/supabase.js"></script>
    <script src="../js/ui.js"></script>
    <script>
        AOS.init();

        // 1. Check Login
        async function checkAccess() {
            if (typeof _supabase === 'undefined') return;
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) window.location.href = '../login.html';
            else loadAvatar(session.user.id);
        }

        async function loadAvatar(uid) {
            const { data } = await _supabase.from('profiles').select('avatar_url').eq('id', uid).single();
            if(data && data.avatar_url) document.getElementById('navAvatar').src = data.avatar_url;
        }

        // --- CALENDAR LOGIC ---
        let currDate = new Date();
        let currYear = currDate.getFullYear();
        let currMonth = currDate.getMonth();
        let fetchedEvents = [];

        const fixedHolidays = {
            "01-01": "New Year", "01-14": "Thai Pongal", "02-04": "Independence Day",
            "04-13": "New Year Eve", "04-14": "Sinhala Tamil New Year", "05-01": "May Day", "12-25": "Christmas"
        };
        const specificHolidays = {
            "2025-01-13": "Duruthu Poya", "2025-02-12": "Navam Poya", "2025-03-13": "Medin Poya",
            "2025-04-12": "Bak Poya", "2025-05-12": "Vesak Poya", "2025-06-10": "Poson Poya",
            "2025-07-10": "Esala Poya", "2025-08-08": "Nikini Poya", "2025-09-07": "Binara Poya",
            "2025-10-06": "Vap Poya", "2025-11-05": "Il Poya", "2025-12-04": "Unduvap Poya",
            "2026-01-03": "Duruthu Poya", "2026-02-01": "Navam Poya", "2026-03-02": "Medin Poya",
            "2026-04-01": "Bak Poya", "2026-05-01": "Vesak Poya", "2026-05-30": "Adhi Poson",
            "2026-06-29": "Poson Poya", "2026-07-28": "Esala Poya", "2026-08-27": "Nikini Poya",
            "2026-09-25": "Binara Poya", "2026-10-24": "Vap Poya", "2026-11-23": "Il Poya", "2026-12-23": "Unduvap Poya"
        };

        function generateCalendar(year, month) {
            const calGrid = document.getElementById('calGrid');
            const calMonth = document.getElementById('calDisplayMonth');
            
            if (year > 2028) { currYear = 2028; year = 2028; }
            if (year < 2024) { currYear = 2024; year = 2024; }

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            calMonth.innerText = `${monthNames[month]} ${year}`;
            calGrid.innerHTML = "";

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDay; i++) calGrid.innerHTML += `<div></div>`;

            for (let day = 1; day <= daysInMonth; day++) {
                let classes = "cal-day";
                const dateKey = `${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const fullDateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) classes += " today";
                if (fixedHolidays[dateKey] || specificHolidays[fullDateKey]) classes += " holiday";
                if (fetchedEvents.some(e => e.event_date === fullDateKey)) classes += " has-event";

                const holidayName = fixedHolidays[dateKey] || specificHolidays[fullDateKey] || '';
                calGrid.innerHTML += `<div class="${classes}" title="${holidayName}">${day}</div>`;
            }
        }

        function changeMonth(dir) {
            currMonth += dir;
            if (currMonth > 11) { currMonth = 0; currYear++; }
            if (currMonth < 0) { currMonth = 11; currYear--; }
            generateCalendar(currYear, currMonth);
        }

        // --- EVENT LOGIC ---
        async function loadEvents() {
            const { data } = await _supabase
                .from('events')
                .select('*')
                .eq('is_hidden', false)
                .order('event_date', { ascending: true });

            fetchedEvents = data || [];
            generateCalendar(currYear, currMonth);

            const feed = document.getElementById('eventFeed');
            feed.innerHTML = '';

            if(!data || data.length === 0) {
                 feed.innerHTML = `
                    <div class="m3-card p-12 text-center flex flex-col items-center">
                        <div class="w-16 h-16 rounded-full bg-[#252529] flex items-center justify-center text-[#C4C7C5] mb-4">
                            <span class="material-symbols-rounded text-3xl">event_busy</span>
                        </div>
                        <h3 class="text-lg font-medium text-[#E3E3E3]">No Upcoming Events</h3>
                        <p class="text-sm text-[#C4C7C5] mt-1">Check back later for updates.</p>
                    </div>`;
                 return;
            }

            data.forEach((ev, i) => {
                const dateObj = new Date(ev.event_date);
                const month = dateObj.toLocaleString('default', { month: 'short' }).toUpperCase();
                const day = dateObj.getDate();
                const eventTarget = new Date(`${ev.event_date}T${ev.event_time || '00:00:00'}`);
                const uniqueId = `timer-${i}`;

                feed.innerHTML += `
                <div class="m3-card p-6 flex flex-col md:flex-row gap-6 group hover:-translate-y-1 transition-all duration-300 overflow-hidden relative" data-aos="fade-up" data-aos-delay="${i*100}">
                    
                    <!-- Date Box -->
                    <div class="shrink-0 w-full md:w-auto flex md:flex-col items-center justify-center gap-3 md:gap-1 bg-[#252529] rounded-xl p-4 text-center min-w-[80px] border border-[#353539]">
                        <span class="text-[10px] font-bold text-primary uppercase tracking-wider">${month}</span>
                        <span class="text-2xl font-display font-medium text-[#E3E3E3]">${day}</span>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <h2 class="text-xl font-display font-medium text-[#E3E3E3] mb-2 leading-tight group-hover:text-primary transition truncate">${ev.title}</h2>
                        <p class="text-sm text-[#C4C7C5] mb-4 leading-relaxed font-light line-clamp-2">${ev.description || 'Join us for this special event.'}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                             <div class="bg-[#353539] px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider text-[#C4C7C5] flex items-center gap-1">
                                <span class="material-symbols-rounded text-[14px] text-primary">schedule</span> ${ev.event_time ? ev.event_time.slice(0,5) : 'TBA'}
                             </div>
                             <div class="bg-[#353539] px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider text-[#C4C7C5] flex items-center gap-1">
                                <span class="material-symbols-rounded text-[14px] text-error">location_on</span> ${ev.location || 'Horana'}
                             </div>
                        </div>

                        <!-- Timer -->
                        <div class="text-xs font-mono text-primary bg-primary/10 inline-block px-3 py-1 rounded-md border border-primary/20" id="${uniqueId}">
                            Loading Timer...
                        </div>
                    </div>

                    <!-- Image (Optional) -->
                    ${ev.image_url ? `
                    <div class="w-full md:w-40 h-32 rounded-xl overflow-hidden shrink-0 bg-[#252529] order-first md:order-last">
                        <img src="${ev.image_url}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500 opacity-90 group-hover:opacity-100">
                    </div>` : ''}
                </div>`;

                startCountdown(eventTarget, uniqueId);
            });
        }

        function startCountdown(targetDate, id) {
            const updateTimer = () => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                const el = document.getElementById(id);
                if(!el) return;

                if (distance < 0) {
                    el.innerHTML = "Event Started / Ended";
                    el.classList.add('text-error', 'bg-error/10', 'border-error/20');
                    el.classList.remove('text-primary', 'bg-primary/10', 'border-primary/20');
                    return;
                }

                const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);

                el.innerHTML = `${d}d : ${h}h : ${m}m : ${s}s`;
            };
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        checkAccess();
        loadEvents();
    </script>
    <div id="global-footer-placeholder"></div>
    <script src="../js/footer-loader.js"></script>
</body>
</html>