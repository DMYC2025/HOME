<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Payments - DMYSC</title>
    <link rel="icon" type="image/png" href="../assets/logo_1.png">
    
    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- MATERIAL SYMBOLS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    colors: { 
                        // Google Material 3 Dark Colors
                        background: '#121212',
                        surface: '#1E1E1E',
                        'surface-container': '#252529',
                        primary: '#a6f7bd',
                        'on-primary': '#003915',
                        secondary: '#c2c9bd',
                        tertiary: '#a0cfd0',
                        error: '#ffb4ab',
                        'on-error': '#690005',
                        'surface-variant': '#444746',
                    }, 
                    fontFamily: { 
                        sans: ['Roboto', 'sans-serif'],
                        display: ['Outfit', 'sans-serif']
                    }, 
                    borderRadius: {
                        '4xl': '28px',
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.2, 0.0, 0, 1.0)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                } 
            } 
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { 
            background-color: #121212;
            color: #E3E3E3;
            -webkit-tap-highlight-color: transparent;
        }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        
        .m3-card {
            background-color: #1E1E1E;
            border-radius: 24px;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .m3-card:hover {
            background-color: #28282D;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .m3-navbar { background-color: #252529; border-radius: 999px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #252529; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #353539; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-0 font-sans">

    <!-- Top Navigation (Desktop) -->
    <nav class="sticky top-4 z-40 w-full px-4 no-print">
        <div class="max-w-7xl mx-auto m3-navbar px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3 pl-2 group">
                <button class="w-8 h-8 rounded-full bg-[#353539] flex items-center justify-center group-hover:bg-primary group-hover:text-[#003915] transition">
                    <span class="material-symbols-rounded text-[20px]">arrow_back</span>
                </button>
                <div class="flex flex-col">
                    <span class="text-sm font-display font-medium text-[#E3E3E3]">My Payments</span>
                    <span class="text-[10px] text-secondary tracking-wider font-bold">History & Dues</span>
                </div>
            </a>
            
            <div class="flex items-center gap-3">
                <a href="notifycation.html" class="relative w-10 h-10 flex items-center justify-center rounded-full hover:bg-[#3b3b3f] transition text-[#C4C7C5]">
                    <span class="material-symbols-rounded">notifications</span>
                </a>
                <a href="profile.html" class="w-10 h-10 rounded-full p-1 hover:bg-[#3b3b3f] transition hidden md:block">
                    <img id="navAvatar" src="https://img.freepik.com/premium-vector/green-user-account-profile-flat-icon-apps-websites_1254296-1186.jpg" class="w-full h-full rounded-full object-cover">
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        
        <!-- Header Card -->
        <div class="m3-card p-6 md:p-8 relative overflow-hidden bg-[#252529]" data-aos="fade-down">
            <div class="relative z-10">
                <div class="flex items-center gap-2 text-primary mb-2">
                    <span class="material-symbols-rounded">account_balance_wallet</span>
                    <span class="text-xs font-bold uppercase tracking-widest">Financials</span>
                </div>
                <h1 class="text-3xl md:text-5xl font-display font-normal text-[#E3E3E3] leading-tight">
                    Payment <span class="text-primary">History</span>
                </h1>
                <p class="text-[#C4C7C5] mt-2 text-sm md:text-base max-w-xl">
                    Track your membership fees, contributions, and download receipts.
                </p>
            </div>
            <!-- Decorative Elements -->
            <div class="absolute top-[-20px] right-[-20px] w-64 h-64 bg-primary opacity-5 rounded-full blur-3xl"></div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            
            <!-- Left Column: Content -->
            <div class="flex-1 space-y-6">
                
                <!-- Total Summary Card -->
                <div class="m3-card p-6 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6 relative overflow-hidden group bg-[#1b2e23] border border-[#233f2e]" data-aos="fade-up">
                    <div class="absolute right-0 top-0 p-10 opacity-5 group-hover:opacity-10 transition duration-500">
                        <span class="material-symbols-rounded text-9xl text-primary">payments</span>
                    </div>
                    <div class="text-center md:text-left z-10">
                        <p class="text-[#a6f7bd] font-bold uppercase tracking-widest text-xs mb-2 opacity-80">Total Contribution</p>
                        <h2 class="text-4xl md:text-6xl font-display font-normal text-[#E3E3E3] flex items-baseline gap-2 justify-center md:justify-start">
                            <span id="totalPaidDisplay">0</span> <span class="text-lg text-primary font-bold">LKR</span>
                        </h2>
                    </div>
                    <div class="text-center md:text-right z-10">
                        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/20 text-primary border border-primary/30">
                            <span class="material-symbols-rounded text-lg">verified</span> <span class="text-xs font-bold uppercase">Verified Member</span>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="m3-card p-6 bg-[#1E1E1E]" data-aos="fade-up" data-aos-delay="100">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 border-b border-[#353539] pb-4">
                        <h3 class="text-lg font-display font-medium text-[#E3E3E3] flex items-center gap-2">
                            <span class="material-symbols-rounded text-secondary">bar_chart</span> Overview
                        </h3>
                        <div class="flex gap-4 text-[10px] font-bold uppercase tracking-wider text-[#C4C7C5]">
                            <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-primary"></span> Paid</span>
                            <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#353539]">Unpaid</span></span>
                        </div>
                    </div>
                    <div id="paymentChart" class="w-full min-h-[300px]"></div>
                </div>

                <!-- History List -->
                <div id="historyFeed" class="space-y-3">
                    <div class="py-12 text-center">
                        <span class="material-symbols-rounded animate-spin text-3xl text-primary mb-2">sync</span>
                        <p class="text-xs text-[#C4C7C5] uppercase tracking-widest">Loading Records...</p>
                    </div>
                </div>

            </div>

            <!-- Right Column: Sidebar (Status) -->
            <div class="w-full lg:w-80 shrink-0 space-y-4 lg:order-last">
                
                <!-- Membership Status Card -->
                <div class="m3-card p-6 bg-[#252529]" data-aos="fade-left">
                    <h3 class="text-xs font-bold text-secondary uppercase mb-4 tracking-widest flex items-center gap-2">
                        <span class="material-symbols-rounded text-[18px]">info</span> Membership Status
                    </h3>
                    
                    <div id="statusIndicator" class="flex flex-col items-center justify-center p-6 bg-[#1E1E1E] rounded-2xl border border-[#353539] mb-4">
                        <div class="w-16 h-16 rounded-full bg-[#353539] flex items-center justify-center text-3xl mb-3 text-[#C4C7C5] animate-pulse">
                            <span class="material-symbols-rounded">sync</span>
                        </div>
                        <span class="font-bold text-[#E3E3E3] text-sm">Checking...</span>
                    </div>
                    
                    <p class="text-xs text-[#C4C7C5] text-center leading-relaxed font-light">
                        Monthly Fee: <strong class="text-[#E3E3E3]">100 LKR</strong>. <br>Please settle any arrears to maintain active status.
                    </p>
                </div>

                <!-- Arrears Panel (Hidden by default) -->
                <div id="arrearsPanel" class="m3-card p-6 hidden bg-[#3c2525] border border-[#533535]" data-aos="fade-left" data-aos-delay="100">
                    <h3 class="text-xs font-bold text-error uppercase mb-4 tracking-widest flex items-center gap-2">
                        <span class="material-symbols-rounded text-[18px]">error</span> Action Required
                    </h3>
                    <div id="arrearsList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                        <!-- Arrears injected here -->
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Footer -->
    <div id="global-footer-placeholder" class="pb-20 md:pb-0"></div>

    <!-- Mobile Bottom Nav -->
    <div class="md:hidden fixed bottom-0 left-0 w-full z-50 bg-[#1E1E1E] border-t border-[#252529] pb-safe">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center gap-1 w-full text-[#C4C7C5]">
                <span class="material-symbols-rounded">home</span>
                <span class="text-[10px] font-medium">Home</span>
            </a>
            <button class="flex flex-col items-center gap-1 w-full text-primary">
                <div class="w-12 h-7 rounded-full bg-[#003915] flex items-center justify-center">
                    <span class="material-symbols-rounded text-[20px]">account_balance_wallet</span>
                </div>
                <span class="text-[10px] font-medium">Pay</span>
            </button>
            <a href="profile.html" class="flex flex-col items-center gap-1 w-full text-[#C4C7C5]">
                <span class="material-symbols-rounded">person</span>
                <span class="text-[10px] font-medium">Profile</span>
            </a>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="../js/supabase.js"></script>
    <script src="../js/ui.js"></script>
    
    <script>
        AOS.init();
        let currentUserProfile = null;

        async function initPage() {
            // Check Access
            if (typeof _supabase === 'undefined') return;
            const { data: { session } } = await _supabase.auth.getSession();
            if(!session) return window.location.href = '../login.html';
            else loadAvatar(session.user.id);

            // 1. Get User Profile (for Join Date & Name)
            const { data: profile } = await _supabase.from('profiles').select('full_name, member_id, created_at').eq('id', session.user.id).single();
            currentUserProfile = profile;

            // 2. Get All Payments
            const { data: payments } = await _supabase
                .from('payments')
                .select('*')
                .eq('member_id', session.user.id)
                .order('month_year', { ascending: false });

            // 3. Process Data
            renderTotal(payments);
            renderHistory(payments);
            renderChartAndStatus(profile.created_at, payments);
        }

        async function loadAvatar(uid) {
            const { data } = await _supabase.from('profiles').select('avatar_url').eq('id', uid).single();
            if(data && data.avatar_url) document.getElementById('navAvatar').src = data.avatar_url;
        }

        function renderTotal(payments) {
            const total = payments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
            document.getElementById('totalPaidDisplay').innerText = total.toLocaleString();
        }

        function renderHistory(payments) {
            const feed = document.getElementById('historyFeed');
            feed.innerHTML = '<h3 class="text-lg font-display font-medium text-[#E3E3E3] mb-4 px-1">Recent Receipts</h3>';

            if(!payments || payments.length === 0) {
                feed.innerHTML += `
                    <div class="m3-card p-8 text-center flex flex-col items-center bg-[#252529] border-dashed border-2 border-[#353539]">
                        <span class="material-symbols-rounded text-[#C4C7C5] text-3xl mb-2">receipt_long</span>
                        <p class="text-[#C4C7C5] text-sm">No payment history found.</p>
                    </div>`;
                return;
            }

            payments.forEach((p, i) => {
                const date = new Date(p.paid_at).toLocaleDateString();
                feed.innerHTML += `
                <div class="m3-card p-4 flex items-center justify-between group hover:bg-[#252529] transition" data-aos="fade-up" data-aos-delay="${i * 50}">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-[#1b2e23] text-primary flex items-center justify-center border border-[#233f2e] shrink-0">
                            <span class="material-symbols-rounded text-xl">receipt_long</span>
                        </div>
                        <div>
                            <h4 class="font-display font-medium text-[#E3E3E3] text-base">${p.month_year}</h4>
                            <p class="text-[10px] text-[#8e918f] font-mono">Paid on ${date}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-[#E3E3E3] mb-1 text-sm">${p.amount}/=</div>
                        <button onclick="generateReceipt('${p.id}', '${p.month_year}', '${p.amount}', '${p.paid_at}')" class="text-[10px] bg-[#353539] hover:bg-[#E3E3E3] hover:text-[#121212] text-[#C4C7C5] px-3 py-1.5 rounded-full transition font-bold flex items-center gap-1 ml-auto">
                            <span class="material-symbols-rounded text-[14px]">download</span> Save
                        </button>
                    </div>
                </div>`;
            });
        }

        function renderChartAndStatus(joinDateStr, payments) {
            const paidMonthsMap = new Set(payments.map(p => p.month_year));
            const chartCategories = [];
            const chartData = [];
            const arrears = [];

            let start = joinDateStr ? new Date(joinDateStr) : new Date('2024-01-01');
            const now = new Date();
            start.setDate(1);

            while (start <= now) {
                const mStr = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}`;
                chartCategories.push(mStr);

                if (paidMonthsMap.has(mStr)) {
                    chartData.push({ x: mStr, y: 100, fillColor: '#a6f7bd' }); // Primary color
                } else {
                    chartData.push({ x: mStr, y: 100, fillColor: '#353539' }); // Surface Container
                    arrears.push(mStr);
                }
                start.setMonth(start.getMonth() + 1);
            }

            const options = {
                series: [{ name: 'Status', data: chartData }],
                chart: { 
                    type: 'bar', 
                    height: 300, 
                    toolbar: { show: false }, 
                    fontFamily: 'Roboto, sans-serif',
                    background: 'transparent'
                },
                plotOptions: { 
                    bar: { borderRadius: 4, columnWidth: '60%', distributed: true } 
                },
                dataLabels: { enabled: false },
                xaxis: { 
                    categories: chartCategories, 
                    labels: { style: { colors: '#8e918f', fontSize: '10px' }, rotate: -45 },
                    axisBorder: { show: false },
                    axisTicks: { show: false }
                },
                yaxis: { show: false, max: 100 },
                grid: { show: false },
                tooltip: {
                    theme: 'dark',
                    custom: function({ series, seriesIndex, dataPointIndex, w }) {
                        const data = w.config.series[seriesIndex].data[dataPointIndex];
                        const status = data.fillColor === '#a6f7bd' ? 'PAID' : 'UNPAID';
                        const colorClass = status === 'PAID' ? 'text-[#a6f7bd]' : 'text-[#ffb4ab]';
                        return `<div class="px-3 py-2 bg-[#252529] text-xs font-bold border border-[#353539] rounded-lg">
                                    ${data.x}: <span class="${colorClass}">${status}</span>
                                </div>`;
                    }
                }
            };

            const chartEl = document.querySelector("#paymentChart");
            chartEl.innerHTML = ""; 
            new ApexCharts(chartEl, options).render();

            const statusEl = document.getElementById('statusIndicator');
            const arrearsPanel = document.getElementById('arrearsPanel');
            const arrearsList = document.getElementById('arrearsList');

            if (arrears.length > 0) {
                statusEl.innerHTML = `
                    <div class="w-16 h-16 rounded-full bg-[#3c2525] text-error border border-error/20 flex items-center justify-center text-3xl mb-3 shadow-[0_0_20px_rgba(255,180,171,0.1)]">
                        <span class="material-symbols-rounded">warning</span>
                    </div>
                    <span class="font-bold text-error uppercase tracking-widest text-xs">Arrears Found</span>
                `;
                arrearsPanel.classList.remove('hidden');
                arrearsList.innerHTML = '';
                arrears.reverse().forEach(month => {
                    arrearsList.innerHTML += `
                        <div class="flex justify-between items-center bg-[#2d1f1f] p-3 rounded-xl border border-[#533535] hover:bg-[#3c2525] transition">
                            <span class="font-bold text-[#ffdad6] text-sm font-mono">${month}</span>
                            <span class="text-[10px] bg-error text-[#690005] px-2 py-0.5 rounded font-bold">DUE</span>
                        </div>
                    `;
                });
            } else {
                statusEl.innerHTML = `
                    <div class="w-16 h-16 rounded-full bg-[#1b2e23] text-primary border border-primary/20 flex items-center justify-center text-3xl mb-3 shadow-[0_0_20px_rgba(166,247,189,0.1)]">
                        <span class="material-symbols-rounded">check_circle</span>
                    </div>
                    <span class="font-bold text-primary uppercase tracking-widest text-xs">Up to Date</span>
                `;
                arrearsPanel.classList.add('hidden');
            }
        }

        // --- PDF Generation ---
        function getBase64ImageFromURL(url) {
            return new Promise((resolve) => {
                var img = new Image(); img.setAttribute("crossOrigin", "anonymous");
                img.onload = () => {
                    var canvas = document.createElement("canvas"); canvas.width = img.width; canvas.height = img.height;
                    var ctx = canvas.getContext("2d"); ctx.drawImage(img, 0, 0); resolve(canvas.toDataURL("image/png"));
                };
                img.onerror = () => resolve(null); img.src = url;
            });
        }

        async function generateReceipt(payId, month, amount, paidAt) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [100, 150] });
            const logoData = await getBase64ImageFromURL('../assets/logo.png');

            // Header Background (Dark)
            doc.setFillColor(18, 18, 18); doc.rect(0, 0, 100, 30, 'F');
            if (logoData) doc.addImage(logoData, 'PNG', 5, 5, 20, 20);

            doc.setTextColor(255, 255, 255); doc.setFontSize(10); doc.setFont("helvetica", "bold");
            doc.text("Dream Makers", 30, 12); doc.text("Youth & Sports Club", 30, 17);
            doc.setFontSize(8); doc.setTextColor(166, 247, 189); // Primary Color
            doc.text("Official Payment Receipt", 30, 23);

            doc.setTextColor(0, 0, 0); doc.setFont("helvetica", "normal");
            const dateStr = new Date(paidAt).toLocaleString();
            doc.setFontSize(8); doc.setTextColor(100); doc.text("Date: " + dateStr, 50, 38, { align: 'center' });
            doc.setDrawColor(200); doc.line(10, 40, 90, 40);

            let y = 48;
            function addRow(l, v, b=false) {
                doc.setFont("helvetica", "normal"); doc.setFontSize(9); doc.setTextColor(80); doc.text(l, 10, y);
                doc.setFont("helvetica", b?"bold":"normal"); doc.setTextColor(0); doc.text(v, 90, y, { align: 'right' });
                y += 8;
            }

            addRow("Receipt ID", payId.split('-')[0].toUpperCase());
            addRow("Member Name", currentUserProfile ? currentUserProfile.full_name : "Unknown");
            addRow("Payment For", month, true);

            y += 5;
            // Amount Box (Green tint)
            doc.setFillColor(230, 255, 240); doc.roundedRect(10, y-5, 80, 15, 2, 2, 'F');
            doc.setTextColor(0, 57, 21); // On-Primary
            doc.setFontSize(12); doc.setFont("helvetica", "bold");
            doc.text("AMOUNT PAID", 15, y+2); doc.text(amount + " LKR", 85, y+2, { align: 'right' });

            y += 20; doc.setFontSize(7); doc.setTextColor(150);
            doc.text("Thank you for your contribution!", 50, y, { align: 'center' });
            
            doc.save(`Receipt_${month}.pdf`);
        }

        initPage();
    </script>
    <div id="global-footer-placeholder"></div>
    <script src="../js/footer-loader.js"></script>
</body>
</html>